<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Bảng xếp hạng hiệu suất GOPIKA</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    :root{
      --bg:#020617;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:#1e293b;
      --field:#020617;
      --brand:#22c55e;
      --brand-soft:#16a34a;
      --danger:#f97373;
    }

    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      min-height:100vh;
      background:radial-gradient(circle at top,#1f2937 0,#020617 55%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .shell{
      width:100%;
      max-width:960px;
    }
    .card{
      background:radial-gradient(circle at top,#111827 0,#020617 55%);
      border-radius:24px;
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:0 40px 120px rgba(15,23,42,0.9);
      padding:32px 32px 28px;
      position:relative;
      overflow:hidden;
    }

    h1{
      font-size:28px;
      font-weight:700;
      letter-spacing:0.03em;
      margin-bottom:8px;
    }
    .subtitle{
      font-size:14px;
      color:var(--muted);
      margin-bottom:24px;
    }

    .form-row{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      margin-bottom:16px;
    }
    .field{
      flex:1 1 240px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .label{
      font-size:13px;
      color:var(--muted);
    }
    .input{
      border-radius:999px;
      padding:10px 16px;
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.85);
      color:var(--text);
      outline:none;
      font-size:14px;
      transition:border-color .15s, box-shadow .15s, background .15s;
    }
    .input:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(34,197,94,0.4);
      background:rgba(15,23,42,1);
    }
    .input.error{
      border-color:var(--danger);
      box-shadow:0 0 0 1px rgba(248,113,113,0.5);
    }

    .actions{
      display:flex;
      justify-content:flex-end;
    }
    .btn{
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding:10px 32px;
      font-size:15px;
      font-weight:600;
      color:#022c22;
      background:linear-gradient(135deg,#22c55e,#4ade80);
      box-shadow:0 0 40px rgba(34,197,94,0.5);
      transition:transform .1s, box-shadow .1s, filter .1s;
      white-space:nowrap;
    }
    .btn:hover{
      transform:translateY(-1px);
      filter:brightness(1.05);
      box-shadow:0 0 50px rgba(34,197,94,0.7);
    }
    .btn:active{
      transform:translateY(0);
      box-shadow:0 0 24px rgba(34,197,94,0.5);
    }
    .btn:disabled{
      opacity:0.55;
      cursor:wait;
      box-shadow:none;
      transform:none;
    }

    .divider{
      margin:20px 0 16px;
      border:none;
      border-top:1px solid var(--line);
    }

    .status{
      min-height:22px;
      font-size:13px;
      color:var(--muted);
    }
    .status.error{
      color:#fecaca;
    }
    .status.success{
      color:#bbf7d0;
    }

    .result-section{
      display:flex;
      flex-direction:column;
      gap:16px;
      margin-top:8px;
    }
    .result-card{
      border-radius:20px;
      border:1px solid rgba(148,163,184,0.45);
      background:linear-gradient(135deg,rgba(15,23,42,0.95),#020617);
      padding:16px 18px 14px;
    }
    .result-header{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:8px;
      margin-bottom:10px;
    }
    .result-title{
      font-size:15px;
      font-weight:600;
    }
    .pill{
      font-size:11px;
      padding:3px 10px;
      border-radius:999px;
      background:rgba(15,118,110,0.25);
      border:1px solid rgba(45,212,191,0.4);
      color:#a5f3fc;
    }

    .result-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:8px 16px;
      font-size:13px;
    }
    .result-label{
      color:var(--muted);
      font-size:12px;
    }
    .result-value{
      font-weight:500;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:4px;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid rgba(30,41,59,0.9);
      text-align:left;
    }
    th{
      font-weight:500;
      color:var(--muted);
      font-size:12px;
    }
    tr:last-child td{
      border-bottom:none;
    }

    @media (max-width:640px){
      .card{padding:22px 18px 20px;}
      h1{font-size:22px;}
      .btn{width:100%;justify-content:center;}
      .actions{margin-top:4px;}
    }
  </style>
</head>
<body>
<div class="shell">
  <div class="card">
    <h1>Bảng xếp hạng hiệu suất GOPIKA</h1>
    <div class="subtitle">
      Nhập <strong>SĐT</strong> và <strong>Họ tên có dấu</strong> để xem hạng doanh thu / đơn và Chỉ số xếp hạng.
    </div>

    <div class="form-row">
      <div class="field">
        <label class="label" for="phone">Số điện thoại chạy app (đổi 0 thành 84)</label>
        <input id="phone" class="input" placeholder="VD: 84901 234 567">
      </div>
      <div class="field">
        <label class="label" for="fullname">Họ tên (có dấu)</label>
        <input id="fullname" class="input" placeholder="VD: Trịnh Xuân Đức">
      </div>
      <div class="actions">
        <button id="btnLookup" class="btn">Tra cứu</button>
      </div>
    </div>

    <div id="status" class="status"></div>
    <hr class="divider">

    <div id="results" class="result-section" style="display:none">
      <div class="result-card" id="selfCard">
        <div class="result-header">
          <div class="result-title">Thông tin của bạn</div>
          <div class="pill" id="selfRankPill"></div>
        </div>
        <div class="result-grid" id="selfGrid"></div>
      </div>

      <div class="result-card" id="compareCard" style="display:none">
        <div class="result-header">
          <div class="result-title">So sánh hiệu suất</div>
        </div>
        <table>
          <thead>
          <tr>
            <th>Tài xế</th>
            <th>Doanh thu</th>
            <th>Đơn</th>
            <th>Hạng DT</th>
            <th>Hạng Đơn</th>
            <th>Chỉ số xếp hạng</th>
            <th>Hạng hiệu suất</th>
          </tr>
          </thead>
          <tbody id="compareBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // TODO: thay URL này bằng Web App URL của Apps Script
  const API_URL = 'https://script.google.com/macros/s/AKfycbz8uQNlZiL_Vvjpy3SQtO-PNwrwsXY5hMlBfuze4sCCcs0fIOBe0iFAWA6EZ5jYvruUnQ/exec';

  const phoneInput   = document.getElementById('phone');
  const nameInput    = document.getElementById('fullname');
  const btnLookup    = document.getElementById('btnLookup');
  const statusEl     = document.getElementById('status');
  const resultsEl    = document.getElementById('results');
  const selfGridEl   = document.getElementById('selfGrid');
  const selfRankPill = document.getElementById('selfRankPill');
  const compareCard  = document.getElementById('compareCard');
  const compareBody  = document.getElementById('compareBody');

  function setStatus(msg, type='info') {
    statusEl.textContent = msg || '';
    statusEl.className = 'status' + (type === 'error' ? ' error' : (type === 'success' ? ' success' : ''));
  }

  function clearErrors() {
    phoneInput.classList.remove('error');
    nameInput.classList.remove('error');
  }

  async function doLookup() {
    clearErrors();
    setStatus('');
    resultsEl.style.display = 'none';

    const phone = phoneInput.value.trim();
    const name  = nameInput.value.trim();

    if (!phone) {
      phoneInput.classList.add('error');
      setStatus('Vui lòng nhập số điện thoại.', 'error');
      phoneInput.focus();
      return;
    }
    if (!name) {
      nameInput.classList.add('error');
      setStatus('Vui lòng nhập đầy đủ họ tên (có dấu).', 'error');
      nameInput.focus();
      return;
    }

    btnLookup.disabled = true;

    try {
      const url = `${API_URL}?phone=${encodeURIComponent(phone)}&name=${encodeURIComponent(name)}`;
      const res = await fetch(url);
      const data = await res.json();

      if (!data.ok) {
        // highlight tương ứng theo code
        if (data.code === 'MISSING_PHONE' || data.code === 'PHONE_NOT_FOUND') {
          phoneInput.classList.add('error');
          phoneInput.focus();
        } else if (data.code === 'MISSING_NAME' || data.code === 'NAME_MISMATCH') {
          nameInput.classList.add('error');
          nameInput.focus();
        }
        setStatus(data.error || 'Không thể tra cứu. Vui lòng thử lại.', 'error');
        return;
      }

      renderResult(data);
      setStatus('Tra cứu thành công.', 'success');

    } catch (err) {
      console.error(err);
      setStatus('Có lỗi khi kết nối hệ thống. Vui lòng thử lại sau.', 'error');
    } finally {
      btnLookup.disabled = false;
    }
  }

  function renderResult(data) {
    const self = data.self || {};
    const compare = data.compare || [];

    // Hiển thị self
    selfGridEl.innerHTML = `
      <div>
        <div class="result-label">Họ tên</div>
        <div class="result-value">${self.name || ''}</div>
      </div>
      <div>
        <div class="result-label">Số điện thoại</div>
        <div class="result-value">${self.phone || ''}</div>
      </div>
      <div>
        <div class="result-label">Doanh thu</div>
        <div class="result-value">${formatNumber(self.fee)}</div>
      </div>
      <div>
        <div class="result-label">Số đơn</div>
        <div class="result-value">${formatNumber(self.order)}</div>
      </div>
      <div>
        <div class="result-label">Hạng doanh thu</div>
        <div class="result-value">Top ${self.rank_fee || '-'}</div>
      </div>
      <div>
        <div class="result-label">Hạng đơn</div>
        <div class="result-value">Top ${self.rank_order || '-'}</div>
      </div>
      <div>
        <div class="result-label">Chỉ số xếp hạng</div>
        <div class="result-value">${self.score ?? '-'}</div>
      </div>
      <div>
        <div class="result-label">Hạng hiệu suất</div>
        <div class="result-value">Top ${self.rank_score || '-'}</div>
      </div>
    `;

    selfRankPill.textContent = `Hạng hiệu suất: Top ${self.rank_score || '-'}`;

    // Hiển thị compare
    if (compare.length > 0) {
      compareBody.innerHTML = '';
      compare.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.displayName || ''}</td>
          <td>${row.fee_mask || '-'}</td>
          <td>${row.order_mask || '-'}</td>
          <td>Top ${row.rank_fee || '-'}</td>
          <td>Top ${row.rank_order || '-'}</td>
          <td>${row.score ?? '-'}</td>
          <td>Top ${row.rank_score || '-'}</td>
        `;
        compareBody.appendChild(tr);
      });
      compareCard.style.display = '';
    } else {
      compareCard.style.display = 'none';
    }

    resultsEl.style.display = '';
  }

  function formatNumber(v) {
    if (v === null || v === undefined || v === '') return '-';
    const num = Number(String(v).replace(/[^\d\-]/g, ''));
    if (isNaN(num)) return v;
    return num.toLocaleString('vi-VN');
  }

  btnLookup.addEventListener('click', doLookup);
  phoneInput.addEventListener('keydown', e => { if (e.key === 'Enter') doLookup(); });
  nameInput.addEventListener('keydown',  e => { if (e.key === 'Enter') doLookup(); });
</script>
</body>
</html>



